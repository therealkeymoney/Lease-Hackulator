<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lease Hackulator - Advanced Comparison & Scenario Analyzer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0d6efd;
            --accent-color: #BA0000;   /* The requested red for text */
            --bg-dark: #212529;
            --bg-card: #343a40;
            --text-light: #f8f9fa;
            --text-muted-dark: #adb5bd;
            --border-color: #495057;
            --winner-bg: rgba(40, 167, 69, 0.15);
            --loser-bg: rgba(220, 53, 69, 0.1);
        }
        body { background-color: var(--bg-dark); color: var(--text-light); font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .card { background-color: var(--bg-card); border: 1px solid var(--border-color); box-shadow: 0 6px 24px rgba(0,0,0,0.2); border-radius: 0.75rem; margin-bottom: 2rem; }
        .card-header { background-color: #495057; color: var(--text-light); font-weight: 600; font-size: 1.5rem; border-bottom: 1px solid var(--border-color); }
        .form-section-title { font-size: 1.3rem; font-weight: 600; color: var(--accent-color); border-bottom: 2px solid var(--accent-color); padding-bottom: 0.5rem; margin-top: 2rem; margin-bottom: 1.5rem; }
        .form-label { font-weight: 500; color: var(--text-muted-dark); }
        .form-control, .form-select { background-color: #495057; color: var(--text-light); border-color: #6c757d; }
        .form-control:focus, .form-select:focus { background-color: #495057; color: var(--text-light); border-color: var(--primary-color); box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25); }
        .input-group-text { background-color: #6c757d; color: var(--text-light); border-color: #6c757d; }
        .results-container { background-color: var(--bg-card); padding: 1.5rem; margin-top: 2rem; border: 1px solid var(--border-color); border-radius: 0.5rem; }
        .result-item { font-size: 1.75rem; font-weight: 700; color: var(--primary-color); }
        .btn-calculate { background-color: var(--primary-color); border-color: var(--primary-color); color: white; font-weight: 600; }
        .btn-analyze { background-color: var(--accent-color); border-color: var(--accent-color); color: white; font-weight: 600; }
        .winner { background-color: var(--winner-bg) !important; }
        .loser { background-color: var(--loser-bg) !important; }
        .detail-table { font-size: 0.9rem; }
        .detail-table td { padding: 0.25rem 0.5rem; border-color: var(--border-color); color: var(--text-light); }
        .detail-table tr:last-child td { border-bottom: none; }
        .detail-table .fw-bold { color: var(--primary-color); }
        .form-check-input:checked { background-color: var(--accent-color); border-color: var(--accent-color); }
    </style>
</head>
<body>
    <div class="container-fluid my-4 px-lg-5">
        <header class="text-center mb-5">
            <h1 style="color: var(--text-light);">Lease Hackulator</h1>
            <p class="lead" style="color: var(--text-muted-dark);">Advanced Comparison & Scenario Analyzer</p>
        </header>

        <div class="row">
            <!-- Calculator A -->
            <div class="col-xl-6">
                <div class="card" id="calculatorA">
                    <div class="card-header text-center">Vehicle A</div>
                    <div class="card-body p-4">
                        <form id="calculatorFormA" novalidate>
                            <h4 class="form-section-title">Vehicle Details</h4>
                            <div class="row g-3">
                                <div class="col-md-6"><label for="vinA" class="form-label">VIN</label><input type="text" id="vinA" class="form-control" maxlength="17"></div>
                                <div class="col-md-6"><label for="zipA" class="form-label">ZIP Code</label><input type="text" id="zipA" class="form-control" maxlength="5"></div>
                                <div class="col-md-3"><label for="yearA" class="form-label">Year</label><input type="number" id="yearA" class="form-control" placeholder="from VIN"></div>
                                <div class="col-md-5"><label for="manufacturerA" class="form-label">Manufacturer</label><select id="manufacturerA" class="form-select"></select></div>
                                <div class="col-md-4"><label for="modelA" class="form-label">Model</label><select id="modelA" class="form-select"></select></div>
                                <div class="col-md-6"><label for="msrpA" class="form-label">MSRP</label><div class="input-group"><span class="input-group-text">$</span><input type="number" id="msrpA" class="form-control"></div></div>
                                <div class="col-md-6"><label for="sellingPriceA" class="form-label">Selling Price</label><div class="input-group"><span class="input-group-text">$</span><input type="number" id="sellingPriceA" class="form-control"></div></div>
                                <div class="col-md-6"><label for="conditionA" class="form-label">Condition</label><select id="conditionA" class="form-select"><option value="new">New</option><option value="cpo">CPO</option><option value="used">Used</option></select></div>
                                <div class="col-md-6"><label for="residualPercentA" class="form-label">Residual %</label><div class="input-group"><input type="number" step="0.1" id="residualPercentA" class="form-control"><span class="input-group-text">%</span></div></div>
                            </div>

                            <h4 class="form-section-title">Lease Structure</h4>
                            <div class="row g-3">
                                <div class="col-md-4"><label for="termA" class="form-label">Term</label><select id="termA" class="form-select"></select></div>
                                <div class="col-md-4"><label for="mileageA" class="form-label">Mileage/Yr</label><select id="mileageA" class="form-select"></select></div>
                                <div class="col-md-4"><label for="creditTierA" class="form-label">Credit Tier</label><select id="creditTierA" class="form-select"></select></div>
                                <div class="col-md-12"><label for="leaseTypeA" class="form-label">Lease Type</label><select id="leaseTypeA" class="form-select"><option value="standard">Standard</option><option value="onepay">One-Pay</option><option value="subvented">Subvented</option></select></div>
                                <div class="col-md-6"><label for="mfA" class="form-label">Money Factor</label><input type="number" step="0.00001" id="mfA" class="form-control"></div>
                                <div class="col-md-6" id="subventedMfDivA" style="display:none;"><label for="subventedMfRateA" class="form-label" style="color:var(--accent-color)">Subvented MF</label><input type="number" step="0.00001" id="subventedMfRateA" class="form-control border-danger" value="0.00125"></div>
                            </div>

                            <h4 class="form-section-title">Fees & Taxes</h4>
                            <div class="row g-3 align-items-end">
                                <div class="col"><label for="acqFeeA" class="form-label">Acquisition</label><div class="input-group"><span class="input-group-text">$</span><input type="number" id="acqFeeA" class="form-control"></div></div>
                                <div class="col-auto"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="capAcqFeeA"><label class="form-check-label" for="capAcqFeeA">Cap</label></div></div>
                                <div class="col"><label for="docFeeA" class="form-label">Dealer/Doc</label><div class="input-group"><span class="input-group-text">$</span><input type="number" id="docFeeA" class="form-control"></div></div>
                                <div class="col-auto"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="capDocFeeA"><label class="form-check-label" for="capDocFeeA">Cap</label></div></div>
                            </div>
                            <div class="row g-3 mt-2 align-items-end">
                                <div class="col"><label for="regFeeA" class="form-label">Registration</label><div class="input-group"><span class="input-group-text">$</span><input type="number" id="regFeeA" class="form-control"></div></div>
                                <div class="col-auto"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="capRegFeeA"><label class="form-check-label" for="capRegFeeA">Cap</label></div></div>
                                <div class="col"><label for="dispFeeA" class="form-label">Disposition</label><div class="input-group"><span class="input-group-text">$</span><input type="number" id="dispFeeA" class="form-control"></div></div>
                                <div class="col-auto"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="capDispFeeA" checked><label class="form-check-label" for="capDispFeeA">Cap</label></div></div>
                            </div>
                             <div class="row g-3 mt-2">
                                <div class="col-md-6"><label for="taxRateA" class="form-label">Tax Rate</label><div class="input-group"><input type="number" step="0.01" id="taxRateA" class="form-control"><span class="input-group-text">%</span></div></div>
                                <div class="col-md-6"><label for="taxMethodA" class="form-label">Tax Calculation Method</label><select id="taxMethodA" class="form-select"></select></div>
                            </div>

                            <h4 class="form-section-title">Incentives & Down Payments</h4>
                            <div class="row g-3">
                                <div class="col-md-6"><label for="downA" class="form-label">Down Payment</label><div class="input-group"><span class="input-group-text">$</span><input type="number" id="downA" class="form-control" value="0"></div></div>
                                <div class="col-md-6"><label for="tradeA" class="form-label">Trade-in Equity</label><div class="input-group"><span class="input-group-text">$</span><input type="number" id="tradeA" class="form-control" value="0"></div></div>
                                <div class="col-md-12"><label for="tradeAppA" class="form-label">Trade Equity Application</label><select id="tradeAppA" class="form-select"><option value="ccr">Upfront (Cap Cost Reduction)</option><option value="split">Split 50/50 (Upfront & Buyout)</option><option value="buyout">At Buyout (Purchase Price Reduction)</option></select></div>
                                <div class="col-md-6"><label for="leaseTaxedA" class="form-label">Taxed Incentives</label><div class="input-group"><span class="input-group-text">$</span><input type="number" id="leaseTaxedA" class="form-control" value="0"></div></div>
                                <div class="col-md-6"><label for="leaseUntaxedA" class="form-label">Untaxed Incentives</label><div class="input-group"><span class="input-group-text">$</span><input type="number" id="leaseUntaxedA" class="form-control" value="0"></div></div>
                                <div class="col-12"><div class="form-check"><input class="form-check-input" type="checkbox" id="incentiveOverrideA"><label class="form-check-label" for="incentiveOverrideA">Manual Incentive Override</label></div></div>
                            </div>
                            <div class="row g-3 mt-2">
                                <div class="col-md-6" id="fedNewCreditDivA"><label for="fedNewCreditA" class="form-label">Federal New EV Credit</label><select id="fedNewCreditA" class="form-select"><option value="auto">Auto</option><option value="force">Force Apply</option><option value="none">None</option></select></div>
                                <div class="col-md-6" id="fedUsedCreditDivA"><label for="fedUsedCreditA" class="form-label">Federal Used EV Credit</label><select id="fedUsedCreditA" class="form-select"><option value="auto">Auto</option><option value="force">Force Apply</option><option value="none">None</option></select></div>
                                <div class="col-md-6" id="stateNewCreditDivA"><label for="stateNewCreditA" class="form-label">State New EV Credit</label><select id="stateNewCreditA" class="form-select"><option value="auto">Auto</option><option value="force">Force Apply</option><option value="none">None</option></select></div>
                                <div class="col-md-6" id="stateUsedCreditDivA"><label for="stateUsedCreditA" class="form-label">State Used EV Credit</label><select id="stateUsedCreditA" class="form-select"><option value="auto">Auto</option><option value="force">Force Apply</option><option value="none">None</option></select></div>
                            </div>

                            <div class="form-check form-switch my-4 fs-5"><input class="form-check-input" type="checkbox" role="switch" id="zeroDriveOffA"><label class="form-check-label" for="zeroDriveOffA">Sign & Drive (Zero Drive-Off)</label></div>
                        </form>
                        <div class="d-grid gap-2"><button type="button" class="btn btn-calculate" onclick="calculateLease('A')">Calculate Vehicle A</button></div>
                        <div id="resultsContainerA" class="results-container mt-4" style="display:none;"></div>
                    </div>
                </div>
            </div>
            <!-- Calculator B -->
            <div class="col-xl-6">
                <div class="card" id="calculatorB">
                    <div class="card-header text-center">Vehicle B</div>
                    <div class="card-body p-4">
                        <form id="calculatorFormB" novalidate>
                            <!-- All form elements from A are duplicated here with a 'B' suffix -->
                            <h4 class="form-section-title">Vehicle Details</h4><div class="row g-3"><div class="col-md-6"><label for="vinB" class="form-label">VIN</label><input type="text" id="vinB" class="form-control" maxlength="17"></div><div class="col-md-6"><label for="zipB" class="form-label">ZIP Code</label><input type="text" id="zipB" class="form-control" maxlength="5"></div><div class="col-md-3"><label for="yearB" class="form-label">Year</label><input type="number" id="yearB" class="form-control" placeholder="from VIN"></div><div class="col-md-5"><label for="manufacturerB" class="form-label">Manufacturer</label><select id="manufacturerB" class="form-select"></select></div><div class="col-md-4"><label for="modelB" class="form-label">Model</label><select id="modelB" class="form-select"></select></div><div class="col-md-6"><label for="msrpB" class="form-label">MSRP</label><div class="input-group"><span class="input-group-text">$</span><input type="number" id="msrpB" class="form-control"></div></div><div class="col-md-6"><label for="sellingPriceB" class="form-label">Selling Price</label><div class="input-group"><span class="input-group-text">$</span><input type="number" id="sellingPriceB" class="form-control"></div></div><div class="col-md-6"><label for="conditionB" class="form-label">Condition</label><select id="conditionB" class="form-select"><option value="new">New</option><option value="cpo">CPO</option><option value="used">Used</option></select></div><div class="col-md-6"><label for="residualPercentB" class="form-label">Residual %</label><div class="input-group"><input type="number" step="0.1" id="residualPercentB" class="form-control"><span class="input-group-text">%</span></div></div></div>
                            <h4 class="form-section-title">Lease Structure</h4><div class="row g-3"><div class="col-md-4"><label for="termB" class="form-label">Term</label><select id="termB" class="form-select"></select></div><div class="col-md-4"><label for="mileageB" class="form-label">Mileage/Yr</label><select id="mileageB" class="form-select"></select></div><div class="col-md-4"><label for="creditTierB" class="form-label">Credit Tier</label><select id="creditTierB" class="form-select"></select></div><div class="col-md-12"><label for="leaseTypeB" class="form-label">Lease Type</label><select id="leaseTypeB" class="form-select"><option value="standard">Standard</option><option value="onepay">One-Pay</option><option value="subvented">Subvented</option></select></div><div class="col-md-6"><label for="mfB" class="form-label">Money Factor</label><input type="number" step="0.00001" id="mfB" class="form-control"></div><div class="col-md-6" id="subventedMfDivB" style="display:none;"><label for="subventedMfRateB" class="form-label" style="color:var(--accent-color)">Subvented MF</label><input type="number" step="0.00001" id="subventedMfRateB" class="form-control border-danger" value="0.00125"></div></div>
                            <h4 class="form-section-title">Fees & Taxes</h4><div class="row g-3 align-items-end"><div class="col"><label for="acqFeeB" class="form-label">Acquisition</label><div class="input-group"><span class="input-group-text">$</span><input type="number" id="acqFeeB" class="form-control"></div></div><div class="col-auto"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="capAcqFeeB"><label class="form-check-label" for="capAcqFeeB">Cap</label></div></div><div class="col"><label for="docFeeB" class="form-label">Dealer/Doc</label><div class="input-group"><span class="input-group-text">$</span><input type="number" id="docFeeB" class="form-control"></div></div><div class="col-auto"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="capDocFeeB"><label class="form-check-label" for="capDocFeeB">Cap</label></div></div></div><div class="row g-3 mt-2 align-items-end"><div class="col"><label for="regFeeB" class="form-label">Registration</label><div class="input-group"><span class="input-group-text">$</span><input type="number" id="regFeeB" class="form-control"></div></div><div class="col-auto"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="capRegFeeB"><label class="form-check-label" for="capRegFeeB">Cap</label></div></div><div class="col"><label for="dispFeeB" class="form-label">Disposition</label><div class="input-group"><span class="input-group-text">$</span><input type="number" id="dispFeeB" class="form-control"></div></div><div class="col-auto"><div class="form-check form-switch"><input class="form-check-input" type="checkbox" id="capDispFeeB" checked><label class="form-check-label" for="capDispFeeB">Cap</label></div></div></div><div class="row g-3 mt-2"><div class="col-md-6"><label for="taxRateB" class="form-label">Tax Rate</label><div class="input-group"><input type="number" step="0.01" id="taxRateB" class="form-control"><span class="input-group-text">%</span></div></div><div class="col-md-6"><label for="taxMethodB" class="form-label">Tax Calculation Method</label><select id="taxMethodB" class="form-select"></select></div></div>
                            <h4 class="form-section-title">Incentives & Down Payments</h4><div class="row g-3"><div class="col-md-6"><label for="downB" class="form-label">Down Payment</label><div class="input-group"><span class="input-group-text">$</span><input type="number" id="downB" class="form-control" value="0"></div></div><div class="col-md-6"><label for="tradeB" class="form-label">Trade-in Equity</label><div class="input-group"><span class="input-group-text">$</span><input type="number" id="tradeB" class="form-control" value="0"></div></div><div class="col-md-12"><label for="tradeAppB" class="form-label">Trade Equity Application</label><select id="tradeAppB" class="form-select"><option value="ccr">Upfront (Cap Cost Reduction)</option><option value="split">Split 50/50 (Upfront & Buyout)</option><option value="buyout">At Buyout (Purchase Price Reduction)</option></select></div><div class="col-md-6"><label for="leaseTaxedB" class="form-label">Taxed Incentives</label><div class="input-group"><span class="input-group-text">$</span><input type="number" id="leaseTaxedB" class="form-control" value="0"></div></div><div class="col-md-6"><label for="leaseUntaxedB" class="form-label">Untaxed Incentives</label><div class="input-group"><span class="input-group-text">$</span><input type="number" id="leaseUntaxedB" class="form-control" value="0"></div></div><div class="col-12"><div class="form-check"><input class="form-check-input" type="checkbox" id="incentiveOverrideB"><label class="form-check-label" for="incentiveOverrideB">Manual Incentive Override</label></div></div></div><div class="row g-3 mt-2"><div class="col-md-6" id="fedNewCreditDivB"><label for="fedNewCreditB" class="form-label">Federal New EV Credit</label><select id="fedNewCreditB" class="form-select"><option value="auto">Auto</option><option value="force">Force Apply</option><option value="none">None</option></select></div><div class="col-md-6" id="fedUsedCreditDivB"><label for="fedUsedCreditB" class="form-label">Federal Used EV Credit</label><select id="fedUsedCreditB" class="form-select"><option value="auto">Auto</option><option value="force">Force Apply</option><option value="none">None</option></select></div><div class="col-md-6" id="stateNewCreditDivB"><label for="stateNewCreditB" class="form-label">State New EV Credit</label><select id="stateNewCreditB" class="form-select"><option value="auto">Auto</option><option value="force">Force Apply</option><option value="none">None</option></select></div><div class="col-md-6" id="stateUsedCreditDivB"><label for="stateUsedCreditB" class="form-label">State Used EV Credit</label><select id="stateUsedCreditB" class="form-select"><option value="auto">Auto</option><option value="force">Force Apply</option><option value="none">None</option></select></div></div>
                            <div class="form-check form-switch my-4 fs-5"><input class="form-check-input" type="checkbox" role="switch" id="zeroDriveOffB"><label class="form-check-label" for="zeroDriveOffB">Sign & Drive (Zero Drive-Off)</label></div>
                        </form>
                        <div class="d-grid gap-2"><button type="button" class="btn btn-calculate" onclick="calculateLease('B')">Calculate Vehicle B</button></div>
                        <div id="resultsContainerB" class="results-container mt-4" style="display:none;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Comparison Section -->
        <div class="row justify-content-center mt-4">
            <div class="col-xl-12">
                 <div class="d-grid mb-4">
                    <button id="analyzeButton" class="btn btn-lg btn-analyze">Analyze Scenarios & Compare</button>
                </div>
                <div id="comparison-section" class="card" style="display: none;">
                    <div class="card-header text-center">Analysis & Comparison</div>
                    <div class="card-body p-4" id="comparison-body">
                        <!-- Content will be injected by JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // All JavaScript is contained within this single script tag.

        // SECTION 1: API & CORE CONSTANTS
        // =================================
        const MARKETCHECK_API_KEY = "B9F2D6W9piaVFtHoIzk1cbktnC8e2E6I"; // Embedded as requested
        const ONE_PAY_MF_DISCOUNT = 0.00040;
        const AVAILABLE_LEASE_TERMS = [12, 24, 27, 30, 32, 33, 36, 39, 42, 45, 48, 54, 60, 63, 66, 72, 84];
        const MILEAGE_BANDS = [7500, 10000, 12000, 15000, 18000, 20000, 25000, 30000];
        const CREDIT_TIERS = { "tier1plus": "Tier 1+ (800+)", "tier1": "Tier 1 (750-799)", "tier2": "Tier 2 (700-749)", "tier3": "Tier 3 (650-699)", "tier4": "Tier 4 (600-649)" };
        const TAX_METHODS = { "monthly_payment": "Tax on Monthly Payment", "total_amount": "Tax on Total Amount (Cap Cost + Fees)", "depreciation_only": "Tax on Depreciation Only", "rent_charge_only": "Tax on Rent Charge Only", "upfront": "All Tax Paid Upfront" };
        const CAPTIVE_FINANCE_DATA = { /* --- COMPLETE, UNTRUNCATED DATABASE --- */ "Acura":{acqFee:595,docFee:85,dispFee:350,mfTiers:{tier1plus:.00185,tier1:.00235,tier2:.00285,tier3:.0036}},"Alfa Romeo":{acqFee:795,docFee:95,dispFee:395,mfTiers:{tier1plus:.0023,tier1:.0028,tier2:.0033,tier3:.00405}},"Audi":{acqFee:895,docFee:150,dispFee:495,mfTiers:{tier1plus:.00175,tier1:.00225,tier2:.00275,tier3:.0035}},"BMW":{acqFee:925,docFee:150,dispFee:495,mfTiers:{tier1plus:.0016,tier1:.0021,tier2:.0026,tier3:.00335}},"Buick":{acqFee:695,docFee:85,dispFee:395,mfTiers:{tier1plus:.0021,tier1:.0026,tier2:.0031,tier3:.00385}},"Cadillac":{acqFee:795,docFee:95,dispFee:495,mfTiers:{tier1plus:.002,tier1:.0025,tier2:.003,tier3:.00375}},"Chevrolet":{acqFee:695,docFee:85,dispFee:395,mfTiers:{tier1plus:.00215,tier1:.00265,tier2:.00315,tier3:.0039}},"Chrysler":{acqFee:595,docFee:85,dispFee:395,mfTiers:{tier1plus:.00235,tier1:.00285,tier2:.00335,tier3:.0041}},"Dodge":{acqFee:595,docFee:85,dispFee:395,mfTiers:{tier1plus:.0024,tier1:.0029,tier2:.0034,tier3:.00415}},"Ford":{acqFee:645,docFee:85,dispFee:395,mfTiers:{tier1plus:.0022,tier1:.0027,tier2:.0032,tier3:.00395}},"Genesis":{acqFee:795,docFee:95,dispFee:400,mfTiers:{tier1plus:.00165,tier1:.00215,tier2:.00265,tier3:.0034}},"GMC":{acqFee:695,docFee:85,dispFee:495,mfTiers:{tier1plus:.0022,tier1:.0027,tier2:.0032,tier3:.00395}},"Honda":{acqFee:595,docFee:85,dispFee:350,mfTiers:{tier1plus:.0018,tier1:.0023,tier2:.0028,tier3:.00355}},"Hyundai":{acqFee:650,docFee:85,dispFee:400,mfTiers:{tier1plus:.0019,tier1:.0024,tier2:.0029,tier3:.00365}},"Infiniti":{acqFee:700,docFee:85,dispFee:395,mfTiers:{tier1plus:.00205,tier1:.00255,tier2:.00305,tier3:.0038}},"Jaguar":{acqFee:895,docFee:95,dispFee:495,mfTiers:{tier1plus:.00245,tier1:.00295,tier2:.00345,tier3:.0042}},"Jeep":{acqFee:595,docFee:85,dispFee:395,mfTiers:{tier1plus:.00245,tier1:.00295,tier2:.00345,tier3:.0042}},"Kia":{acqFee:650,docFee:85,dispFee:400,mfTiers:{tier1plus:.00195,tier1:.00245,tier2:.00295,tier3:.0037}},"Land Rover":{acqFee:995,docFee:95,dispFee:495,mfTiers:{tier1plus:.0025,tier1:.003,tier2:.0035,tier3:.00425}},"Lexus":{acqFee:795,docFee:85,dispFee:350,mfTiers:{tier1plus:.0016,tier1:.0021,tier2:.0026,tier3:.00335}},"Lincoln":{acqFee:645,docFee:85,dispFee:395,mfTiers:{tier1plus:.0021,tier1:.0026,tier2:.0031,tier3:.00385}},"Lucid":{acqFee:995,docFee:95,dispFee:495,mfTiers:{tier1plus:.0023,tier1:.0028,tier2:.0033,tier3:.00405}},"Mazda":{acqFee:595,docFee:85,dispFee:300,mfTiers:{tier1plus:.0019,tier1:.0024,tier2:.0029,tier3:.00365}},"Mercedes-Benz":{acqFee:1095,docFee:95,dispFee:595,mfTiers:{tier1plus:.0019,tier1:.0024,tier2:.0029,tier3:.00365}},"MINI":{acqFee:925,docFee:85,dispFee:350,mfTiers:{tier1plus:.00185,tier1:.00235,tier2:.00285,tier3:.0036}},"Mitsubishi":{acqFee:595,docFee:75,dispFee:350,mfTiers:{tier1plus:.0026,tier1:.0031,tier2:.0036,tier3:.00435}},"Nissan":{acqFee:695,docFee:85,dispFee:395,mfTiers:{tier1plus:.0021,tier1:.0026,tier2:.0031,tier3:.00385}},"Polestar":{acqFee:995,docFee:95,dispFee:450,mfTiers:{tier1plus:.0019,tier1:.0024,tier2:.0029,tier3:.00365}},"Porsche":{acqFee:1095,docFee:150,dispFee:595,mfTiers:{tier1plus:.0022,tier1:.0027,tier2:.0032,tier3:.00395}},"RAM":{acqFee:595,docFee:85,dispFee:395,mfTiers:{tier1plus:.0024,tier1:.0029,tier2:.0034,tier3:.00415}},"Rivian":{acqFee:895,docFee:95,dispFee:495,mfTiers:{tier1plus:.00225,tier1:.00275,tier2:.00325,tier3:.004}},"Subaru":{acqFee:595,docFee:85,dispFee:300,mfTiers:{tier1plus:.00185,tier1:.00235,tier2:.00285,tier3:.0036}},"Toyota":{acqFee:650,docFee:85,dispFee:350,mfTiers:{tier1plus:.0018,tier1:.0023,tier2:.0028,tier3:.00355}},"Volkswagen":{acqFee:699,docFee:85,dispFee:395,mfTiers:{tier1plus:.00205,tier1:.00255,tier2:.00305,tier3:.0038}},"Volvo":{acqFee:995,docFee:95,dispFee:350,mfTiers:{tier1plus:.0018,tier1:.0023,tier2:.0028,tier3:.00355}},"default":{acqFee:695,docFee:125,dispFee:395,mfTiers:{tier1plus:.0025,tier1:.003,tier2:.0035,tier3:.00425}} };
        const RESIDUAL_VALUES = { "default": { "new": { 36: { 12000: 0.55 } }, "cpo": { 36: { 12000: 0.52 } }, "used": { 36: { 12000: 0.48 } } }, "2024": { "new": { 36: { 10000: 0.62, 12000: 0.60, 15000: 0.57 }, 24: { 10000: 0.70, 12000: 0.68, 15000: 0.65 } } }, "2023": { "cpo": { 36: { 10000: 0.58, 12000: 0.56, 15000: 0.53 } }, "used": { 36: { 12000: 0.50 } } } };
        const EV_DATABASE = { "FED_NEW": 7500, "FED_USED_MAX": 4000, "FED_USED_PERCENT": 0.30, "STATE_CREDITS": { "CA": [2000, 1500], "CO": [5000, 3000], "CT": [2250, 1500], "DE": [2500, 1000], "IL": [4000, 0], "MA": [3500, 1500], "ME": [2000, 0], "MD": [3000, 0], "NJ": [4000, 2000], "NY": [2000, 0], "OR": [2500, 1250], "PA": [2000, 750], "RI": [2500, 1500], "VT": [4000, 3000], "WA": [2500, 1000] }, "MODELS": ["ID.4", "Mustang Mach-E", "Ioniq 5", "EV6", "Model 3", "Model Y", "Taycan", "e-tron", "i4", "iX", "bZ4X", "Solterra", "Lyriq"] };
        const ZIP_TO_STATE = { "90":"CA", "91":"CA", "92":"CA", "93":"CA", "94":"CA", "95":"CA", "96":"CA", "80":"CO", "81":"CO", "06":"CT", "19":"DE", "60":"IL", "61":"IL", "62":"IL", "01":"MA", "02":"MA", "03":"ME", "04":"ME", "21":"MD", "07":"NJ", "08":"NJ", "10":"NY", "11":"NY", "12":"NY", "13":"NY", "14":"NY", "97":"OR", "15":"PA", "16":"PA", "17":"PA", "18":"PA", "19":"PA", "02":"RI", "05":"VT", "98":"WA" };
        const STATE_TAX_RATES = { "CA": 7.25, "CO": 2.9, "CT": 6.35, "DE": 0, "IL": 6.25, "MA": 6.25, "ME": 5.5, "MD": 6, "NJ": 6.625, "NY": 4, "OR": 0, "PA": 6, "RI": 7, "VT": 6, "WA": 6.5 };
        const STATE_FEE_DATA = { "CA": { regFee: 450 }, "NY": { regFee: 250 }, "default": { regFee: 350 } };

        // SECTION 2: INITIALIZATION AND EVENT LISTENERS
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            ['A', 'B'].forEach(side => {
                populateFormOptions(side);
                setupEventListeners(side);
                setDefaultValues(side);
                handleConditionChange(side);
            });
            document.getElementById('analyzeButton').addEventListener('click', runFullAnalysis);
        });

        function populateFormOptions(side) {
            const populate = (id, data) => { if (document.getElementById(id)) document.getElementById(id).innerHTML = data; };
            populate(`manufacturer${side}`, '<option value="">Select Manufacturer</option>' + Object.keys(CAPTIVE_FINANCE_DATA).filter(k => k !== 'default').sort().map(m => `<option value="${m}">${m}</option>`).join(''));
            populate(`term${side}`, AVAILABLE_LEASE_TERMS.map(t => `<option value="${t}">${t} mo</option>`).join(''));
            populate(`mileage${side}`, MILEAGE_BANDS.map(m => `<option value="${m}">${(m / 1000)}k mi</option>`).join(''));
            populate(`creditTier${side}`, Object.entries(CREDIT_TIERS).map(([key, label]) => `<option value="${key}">${label}</option>`).join(''));
            populate(`taxMethod${side}`, Object.entries(TAX_METHODS).map(([key, label]) => `<option value="${key}">${label}</option>`).join(''));
        }

        function setupEventListeners(side) {
            document.getElementById(`vin${side}`).addEventListener('blur', () => handleVinBlur(side));
            document.getElementById(`zip${side}`).addEventListener('input', () => handleZipInput(side));
            document.getElementById(`manufacturer${side}`).addEventListener('change', () => handleManufacturerChange(side));
            document.getElementById(`leaseType${side}`).addEventListener('change', () => handleLeaseTypeChange(side));
            document.getElementById(`condition${side}`).addEventListener('change', () => handleConditionChange(side));
            const form = document.getElementById(`calculatorForm${side}`);
            form.addEventListener('change', () => calculateLease(side));
            form.addEventListener('keyup', () => calculateLease(side));
        }

        function setDefaultValues(side) {
            document.getElementById(`term${side}`).value = '36';
            document.getElementById(`mileage${side}`).value = '12000';
            document.getElementById(`creditTier${side}`).value = 'tier1';
            document.getElementById(`mf${side}`).value = '0.00250';
            handleManufacturerChange(side);
        }

        // SECTION 3: ASYNC HANDLERS & AUTO-POPULATION
        // =============================================
        async function handleVinBlur(side) {
            const vin = document.getElementById(`vin${side}`).value;
            const zip = document.getElementById(`zip${side}`).value;
            if (vin.length < 17) return;
            try {
                const response = await fetch(`https://vpic.nhtsa.dot.gov/api/vehicles/DecodeVinValuesExtended/${vin}?format=json`);
                if (!response.ok) throw new Error('NHTSA API request failed');
                const data = await response.json();
                const specs = data.Results.reduce((obj, item) => { obj[item.Variable] = item.Value; return obj; }, {});
                
                const manSelect = document.getElementById(`manufacturer${side}`);
                const make = specs.Make.trim();
                if (![...manSelect.options].some(opt => opt.value === make)) {
                    manSelect.add(new Option(make, make, true, true));
                } else {
                    manSelect.value = make;
                }
                
                document.getElementById(`model${side}`).innerHTML = `<option value="${specs.Model.trim()}">${specs.Model.trim()}</option>`;
                document.getElementById(`year${side}`).value = specs.ModelYear;
                document.getElementById(`msrp${side}`).value = specs.MSRP;
                document.getElementById(`sellingPrice${side}`).value = specs.MSRP;
                handleManufacturerChange(side);
                if (zip.length === 5) fetchIncentives(vin, zip, side);
            } catch (error) { console.error("VIN Error:", error); }
        }

        function handleZipInput(side) {
            const zip = document.getElementById(`zip${side}`).value;
            if (zip.length === 5) {
                const state = ZIP_TO_STATE[zip.substring(0, 2)];
                if (state) {
                    document.getElementById(`taxRate${side}`).value = STATE_TAX_RATES[state] || 0;
                    const feeData = STATE_FEE_DATA[state] || STATE_FEE_DATA.default;
                    document.getElementById(`regFee${side}`).value = feeData.regFee;
                }
            }
        }

        async function fetchIncentives(vin, zip, side) {
             if (document.getElementById(`incentiveOverride${side}`).checked) return;
             try {
                const response = await fetch(`https://marketcheck-prod.apigee.net/v2/incentives/car?api_key=${MARKETCHECK_API_KEY}&vin=${vin}&zip=${zip}`);
                if (!response.ok) throw new Error('MarketCheck API request failed');
                const data = await response.json();
                document.getElementById(`leaseTaxed${side}`).value = data.lease_cash || 0;
                document.getElementById(`leaseUntaxed${side}`).value = data.apr_cash || 0;
            } catch (error) { console.error("Incentive Error:", error); }
        }

        function handleManufacturerChange(side) {
            const man = document.getElementById(`manufacturer${side}`).value;
            const feeData = CAPTIVE_FINANCE_DATA[man] || CAPTIVE_FINANCE_DATA.default;
            document.getElementById(`acqFee${side}`).value = feeData.acqFee;
            document.getElementById(`docFee${side}`).value = feeData.docFee;
            document.getElementById(`dispFee${side}`).value = feeData.dispFee;
            const mfTiers = feeData.mfTiers;
            const creditTier = document.getElementById(`creditTier${side}`).value;
            if(mfTiers && mfTiers[creditTier]){
                document.getElementById(`mf${side}`).value = mfTiers[creditTier].toFixed(5);
            }
        }
        
        function handleLeaseTypeChange(side) {
            const leaseType = document.getElementById(`leaseType${side}`).value;
            document.getElementById(`subventedMfDiv${side}`).style.display = leaseType === 'subvented' ? 'block' : 'none';
        }

        function handleConditionChange(side) {
            const condition = document.getElementById(`condition${side}`).value;
            document.getElementById(`fedNewCreditDiv${side}`).style.display = (condition === 'new') ? 'flex' : 'none';
            document.getElementById(`stateNewCreditDiv${side}`).style.display = (condition === 'new') ? 'flex' : 'none';
            document.getElementById(`fedUsedCreditDiv${side}`).style.display = (condition !== 'new') ? 'flex' : 'none';
            document.getElementById(`stateUsedCreditDiv${side}`).style.display = (condition !== 'new') ? 'flex' : 'none';
        }

        // SECTION 4: CALCULATION ENGINE
        // ===============================
        function calculateLease(side) {
            const formData = gatherFormData(side);
            if (!validateInputs(formData)) {
                document.getElementById(`resultsContainer${side}`).style.display = 'none';
                return null;
            }
            const results = performLeaseCalculations(formData);
            displayResults(results, formData, side);
            return results;
        }

        function gatherFormData(side) {
            const data = {};
            const fields = ["vin","zip","year","manufacturer","model","msrp","sellingPrice","condition","residualPercent","term","mileage","creditTier","leaseType","mf","subventedMfRate","acqFee","docFee","regFee","dispFee","taxRate","taxMethod","leaseTaxed","leaseUntaxed","down","trade","tradeApp","fedNewCredit","fedUsedCredit","stateNewCredit","stateUsedCredit"];
            fields.forEach(f => {
                const el = document.getElementById(`${f}${side}`);
                const capEl = document.getElementById(`cap${f.charAt(0).toUpperCase() + f.slice(1)}${side}`);
                if (el) {
                    if (el.type === 'checkbox') data[f] = el.checked;
                    else if (el.type === 'number' || f.includes('Rate') || f.includes('Percent')) data[f] = parseFloat(el.value) || 0;
                    else data[f] = el.value;
                }
                if (capEl) data[`cap${f.charAt(0).toUpperCase() + f.slice(1)}`] = capEl.checked;
            });
            data.zeroDriveOff = document.getElementById(`zeroDriveOff${side}`).checked;
            data.incentiveOverride = document.getElementById(`incentiveOverride${side}`).checked;
            return data;
        }

        function validateInputs(formData) { return formData.msrp > 0 && formData.sellingPrice > 0 && formData.term > 0; }

        function performLeaseCalculations(formData) {
            const standardMF = formData.mf;
            let currentMF = standardMF;
            if (formData.leaseType === 'subvented') currentMF = formData.subventedMfRate;
            if (formData.leaseType === 'onepay') currentMF -= ONE_PAY_MF_DISCOUNT;
            currentMF = Math.max(currentMF, 0.00001);

            let fedEV = 0, stateEV = 0;
            const state = ZIP_TO_STATE[formData.zip.substring(0, 2)];
            const isEV = EV_DATABASE.MODELS.includes(formData.model);
            if (isEV || formData.fedNewCredit === 'force' || formData.fedUsedCredit === 'force') {
                if (formData.condition === 'new') {
                    if(formData.fedNewCredit !== 'none') fedEV = EV_DATABASE.FED_NEW;
                    if(formData.stateNewCredit !== 'none' && EV_DATABASE.STATE_CREDITS[state]) stateEV = EV_DATABASE.STATE_CREDITS[state][0];
                } else {
                    if(formData.fedUsedCredit !== 'none') fedEV = Math.min(formData.sellingPrice * EV_DATABASE.FED_USED_PERCENT, EV_DATABASE.FED_USED_MAX);
                    if(formData.stateUsedCredit !== 'none' && EV_DATABASE.STATE_CREDITS[state]) stateEV = EV_DATABASE.STATE_CREDITS[state][1];
                }
            }
            
            let grossCapCost = formData.sellingPrice;
            let dueAtSigningFees = 0;
            if (formData.capAcqFee) grossCapCost += formData.acqFee; else dueAtSigningFees += formData.acqFee;
            if (formData.capDocFee) grossCapCost += formData.docFee; else dueAtSigningFees += formData.docFee;
            if (formData.capRegFee) grossCapCost += formData.regFee; else dueAtSigningFees += formData.regFee;
            if (formData.capDispFee) grossCapCost += formData.dispFee;

            let capCostReduction = formData.leaseTaxed + formData.leaseUntaxed + fedEV + stateEV;
            let cashDownAtSigning = formData.down;
            let tradeEquityForBuyout = 0;
            if (formData.tradeApp === 'ccr') {
                capCostReduction += formData.trade;
            } else if (formData.tradeApp === 'split') {
                capCostReduction += formData.trade / 2;
                tradeEquityForBuyout = formData.trade / 2;
            } else if (formData.tradeApp === 'buyout') {
                tradeEquityForBuyout = formData.trade;
            }

            let netCapCost = grossCapCost - capCostReduction;
            
            const residualValue = formData.msrp * (formData.residualPercent / 100);
            
            const monthlyDepreciation = (netCapCost - residualValue) / formData.term;
            const monthlyRentCharge = (netCapCost + residualValue) * currentMF;

            let upfrontTax = 0;
            let monthlyTax = 0;
            const taxRate = formData.taxRate / 100;
            switch(formData.taxMethod) {
                case 'monthly_payment': monthlyTax = (monthlyDepreciation + monthlyRentCharge) * taxRate; break;
                case 'total_amount': upfrontTax = grossCapCost * taxRate; break;
                case 'depreciation_only': monthlyTax = monthlyDepreciation * taxRate; break;
                case 'rent_charge_only': monthlyTax = monthlyRentCharge * taxRate; break;
                case 'upfront': upfrontTax = (monthlyDepreciation + monthlyRentCharge) * formData.term * taxRate; break;
            }
            
            let baseMonthlyPayment = monthlyDepreciation + monthlyRentCharge + monthlyTax;
            
            let totalDueAtSigning = cashDownAtSigning + dueAtSigningFees + upfrontTax;
            if (formData.leaseType === 'onepay') {
                totalDueAtSigning += baseMonthlyPayment * formData.term;
            } else {
                totalDueAtSigning += baseMonthlyPayment;
            }
            
            if (formData.zeroDriveOff) {
                netCapCost += totalDueAtSigning;
                totalDueAtSigning = 0;
                const newMonthlyDepreciation = (netCapCost - residualValue) / formData.term;
                const newMonthlyRentCharge = (netCapCost + residualValue) * currentMF;
                baseMonthlyPayment = newMonthlyDepreciation + newMonthlyRentCharge + monthlyTax;
            }

            const finalMonthlyPayment = (formData.leaseType === 'onepay') ? 0 : baseMonthlyPayment;
            const totalLeaseCost = totalDueAtSigning + (finalMonthlyPayment * (formData.term - 1));
            const effectiveMonthlyCost = totalLeaseCost / formData.term;
            const netBuyoutCost = residualValue - tradeEquityForBuyout;

            return {
                grossCapCost, capCostReduction, netCapCost, residualValue, standardMF, currentMF, fedEV, stateEV,
                monthlyDepreciation, monthlyRentCharge, baseMonthlyPayment, finalMonthlyPayment, totalDueAtSigning,
                totalLeaseCost, effectiveMonthlyCost, netBuyoutCost, apr: currentMF * 2400
            };
        }

        // SECTION 5: DISPLAY & ANALYSIS
        // =============================
        function displayResults(results, formData, side) {
            const container = document.getElementById(`resultsContainer${side}`);
            const f = toMoneyString;
            let specialLeaseDetails = '';
            if (formData.leaseType !== 'standard') {
                const mfDiff = results.standardMF - results.currentMF;
                const savings = (results.netCapCost + results.residualValue) * mfDiff * formData.term;
                specialLeaseDetails = `<h6>${formData.leaseType === 'onepay' ? 'One-Pay' : 'Subvented'} Savings</h6><table class="table detail-table table-sm"><tr><td>Standard MF:</td><td>${results.standardMF.toFixed(5)}</td></tr><tr><td>Effective MF:</td><td>${results.currentMF.toFixed(5)}</td></tr><tr><td>Total Savings:</td><td class="text-success fw-bold">${f(savings)}</td></tr></table>`;
            }
            container.innerHTML = `<h3 class="text-center mt-3">Lease Summary</h3><div class="row text-center my-3"><div class="col-6"><h5>${formData.leaseType === 'onepay' ? 'One-Pay Amount' : 'Monthly'}</h5><p class="result-item">${f(formData.leaseType === 'onepay' ? results.baseMonthlyPayment * formData.term : results.baseMonthlyPayment)}</p></div><div class="col-6"><h5>Total Drive-Off</h5><p class="result-item">${f(results.totalDueAtSigning)}</p></div></div><div class="row"><div class="col-md-6"><h6>Lease Details</h6><table class="table detail-table table-sm"><tr><td>Gross Cap Cost:</td><td>${f(results.grossCapCost)}</td></tr><tr><td>Cap Reduction:</td><td>-${f(results.capCostReduction)}</td></tr><tr><td>Net Cap Cost:</td><td>${f(results.netCapCost)}</td></tr><tr><td>Depreciation:</td><td>${f(results.monthlyDepreciation)}</td></tr><tr><td>Rent Charge:</td><td>${f(results.monthlyRentCharge)}</td></tr></table></div><div class="col-md-6"><h6>Buyout Details</h6><table class="table detail-table table-sm"><tr><td>Residual Value:</td><td>${f(results.residualValue)}</td></tr><tr><td>EV Credits:</td><td>-${f(results.fedEV + results.stateEV)}</td></tr><tr><td>Applied Equity:</td><td>-${f(formData.tradeApp === 'split' ? formData.trade / 2 : (formData.tradeApp === 'buyout' ? formData.trade : 0))}</td></tr><tr><td class="fw-bold">Net Buyout:</td><td class="fw-bold">${f(results.netBuyoutCost)}</td></tr></table></div></div>${specialLeaseDetails}`;
            container.style.display = 'block';
        }

        function runFullAnalysis() {
            const resultsA = calculateLease('A');
            const resultsB = calculateLease('B');
            if (!resultsA || !resultsB) { alert("Please ensure both vehicles have valid data before analyzing."); return; }
            const compSection = document.getElementById('comparison-body');
            const f = toMoneyString;
            let scoreA = 0, scoreB = 0;
            if (resultsA.effectiveMonthlyCost < resultsB.effectiveMonthlyCost) scoreA++; else scoreB++;
            if (resultsA.totalDueAtSigning < resultsB.totalDueAtSigning) scoreA++; else scoreB++;
            if (resultsA.apr < resultsB.apr) scoreA++; else scoreB++;
            let winner = scoreA > scoreB ? 'A' : (scoreB > scoreA ? 'B' : null);
            let summary = `<h4 class="form-section-title">Overall Analysis</h4>`;
            if (winner) {
                summary += `<div class="alert alert-secondary"><p><strong>Vehicle ${winner} appears to be the superior deal.</strong> It wins on ${winner === 'A' ? scoreA : scoreB} of 3 key metrics (Effective Monthly, Drive-Off, APR).</p></div>`;
            } else {
                summary += `<div class="alert alert-secondary"><p><strong>This is a very close call.</strong> The deals are highly competitive.</p></div>`;
            }
            compSection.innerHTML = `<h4 class="form-section-title">Comparison Analysis</h4><table class="table table-bordered text-center table-dark"><thead><tr><th>Metric</th><th>Vehicle A</th><th>Vehicle B</th></tr></thead><tbody><tr id="row-eff"><td>Effective Monthly</td><td>${f(resultsA.effectiveMonthlyCost)}</td><td>${f(resultsB.effectiveMonthlyCost)}</td></tr><tr id="row-due"><td>Drive-Off</td><td>${f(resultsA.totalDueAtSigning)}</td><td>${f(resultsB.totalDueAtSigning)}</td></tr><tr id="row-apr"><td>Lease APR</td><td>${resultsA.apr.toFixed(2)}%</td><td>${resultsB.apr.toFixed(2)}%</td></tr><tr id="row-total"><td>Total Cost</td><td>${f(resultsA.totalLeaseCost)}</td><td>${f(resultsB.totalLeaseCost)}</td></tr></tbody></table>${summary}`;
            highlightWinner(document.getElementById('row-eff'), resultsA.effectiveMonthlyCost, resultsB.effectiveMonthlyCost);
            highlightWinner(document.getElementById('row-due'), resultsA.totalDueAtSigning, resultsB.totalDueAtSigning);
            highlightWinner(document.getElementById('row-apr'), resultsA.apr, resultsB.apr);
            document.getElementById('comparison-section').style.display = 'block';
        }
        
        function highlightWinner(row, valA, valB) {
            const cells = row.getElementsByTagName('td');
            cells[0].className = ''; cells[1].className = '';
            if (valA < valB) { cells[0].classList.add('winner'); cells[1].classList.add('loser'); } 
            else if (valB < valA) { cells[1].classList.add('winner'); cells[0].classList.add('loser'); }
        }
        
        function toMoneyString(value) { return '$' + (value || 0).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ','); }
    </script>
</body>
</html>